version: '3.8'

services:
  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: erp_backend
    ports:
      - "8100:8000"
    volumes:
      - ./backend:/app
      - ./backend/storage:/app/storage
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_HOST=general_server_configs
      - DB_PORT=3306
      - DB_DATABASE=db_erp_drymix_prod
      - DB_USERNAME=amit
      - DB_PASSWORD=angles
      - REDIS_HOST=general_server_configs
      - REDIS_PORT=6379
      - REDIS_PASSWORD=angles
    external_links:
      - general_server_configs
    depends_on:
      - general_server_configs
    networks:
      - erp_network

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: erp_frontend
    ports:
      - "3100:80"
    volumes:
      - ./frontend:/app
    depends_on:
      - backend
    networks:
      - erp_network

  # Grafana for Dashboard (connected to external Grafana)
  grafana-connector:
    image: python:3.11-slim
    container_name: erp_grafana_connector
    volumes:
      - ./docker/grafana:/app
    working_dir: /app
    command: >
      bash -c "pip install -r requirements.txt && python connector.py"
    environment:
      - GRAFANA_URL=http://general_server_configs:3000
      - GRAFANA_USER=admin
      - GRAFANA_PASSWORD=angles
      - DB_HOST=general_server_configs
      - DB_PORT=3306
      - DB_NAME=db_erp_drymix_prod
      - DB_USER=amit
      - DB_PASSWORD=angles
    external_links:
      - general_server_configs
    depends_on:
      - general_server_configs
    networks:
      - erp_network

  # Python for Data Processing
  python-worker:
    build:
      context: ./docker/python
      dockerfile: Dockerfile
    container_name: erp_python_worker
    volumes:
      - ./backend/app/Services/Python:/app/services
      - ./backend/storage:/app/storage
    command: >
      bash -c "pip install -r /app/requirements.txt && python worker.py"
    environment:
      - REDIS_HOST=general_server_configs
      - REDIS_PORT=6379
      - REDIS_PASSWORD=angles
      - DB_HOST=general_server_configs
      - DB_PORT=3306
      - DB_NAME=db_erp_drymix_prod
      - DB_USER=amit
      - DB_PASSWORD=angles
    external_links:
      - general_server_configs
    depends_on:
      - general_server_configs
    networks:
      - erp_network

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: erp_nginx
    ports:
      - "8080:80"
      - "8443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./docker/nginx/ssl:/etc/nginx/ssl
    depends_on:
      - backend
      - frontend
    networks:
      - erp_network

networks:
  erp_network:
    driver: bridge
    external: false
