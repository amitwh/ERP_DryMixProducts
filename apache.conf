# ERP DryMix Products - Apache Configuration
# Version: 1.0.0

<VirtualHost *:80>
    ServerName erp.yourcompany.com
    ServerAdmin admin@yourcompany.com

    DocumentRoot /var/www/erp/dist

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/erp-error.log
    CustomLog ${APACHE_LOG_DIR}/erp-access.log combined

    # Let's Encrypt challenge
    <Directory "/var/www/erp">
        AllowOverride None
        Require all granted
    </Directory>

    # Redirect to HTTPS
    RewriteEngine on
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName erp.yourcompany.com
    ServerAdmin admin@yourcompany.com

    DocumentRoot /var/www/erp/dist

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/erp.yourcompany.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/erp.yourcompany.com/privkey.pem

    # SSL Security
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on
    SSLCompression off
    SSLSessionTickets off
    SSLUseStapling on
    SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"

    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' https:; frame-ancestors 'self';"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/erp-error.log
    CustomLog ${APACHE_LOG_DIR}/erp-access.log combined

    # Frontend - SPA routing
    <Directory "/var/www/erp/dist">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # SPA routing
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.html$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.html [L]
        </IfModule>

        # Cache static files
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
            ExpiresByType image/x-icon "access plus 1 year"
            ExpiresByType font/woff "access plus 1 year"
            ExpiresByType font/woff2 "access plus 1 year"
            ExpiresByType font/ttf "access plus 1 year"
        </IfModule>

        # Compress output
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript
        </IfModule>
    </Directory>

    # Backend API
    <Directory "/var/www/erp/backend/public">
        Options -Indexes +FollowSymLinks +MultiViews
        AllowOverride All
        Require all granted

        # Limit request size
        LimitRequestBody 104857600

        # Security
        <FilesMatch "\.php$">
            SetHandler "proxy:unix:/var/run/php/php8.2-fpm.sock|fcgi://localhost"
        </FilesMatch>
    </Directory>

    # Storage files
    Alias /storage /var/www/erp/backend/storage/app/public
    <Directory "/var/www/erp/backend/storage/app/public">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        # Cache uploaded files
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType image/jpeg "access plus 30 days"
            ExpiresByType image/png "access plus 30 days"
            ExpiresByType application/pdf "access plus 30 days"
        </IfModule>

        # Prevent execution of uploaded files
        <FilesMatch "\.php$">
            Require all denied
        </FilesMatch>
    </Directory>

    # Deny access to hidden files
    <DirectoryMatch "/\.">
        Require all denied
    </DirectoryMatch>

    # Deny access to sensitive files
    <FilesMatch "(\.env|\.git|composer\.(json|lock)|package\.(json|lock))$">
        Require all denied
    </FilesMatch>

    # Gzip compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml
    </IfModule>

    # Performance
    EnableSendfile on
    EnableMMAP off

    # Security
    <IfModule mod_security2.c>
        SecRuleEngine On
        SecRuleRemoveById 981173
    </IfModule>

    # Rate limiting
    <IfModule mod_evasive20.c>
        DOSHashTableSize 3097
        DOSPageCount 10
        DOSSiteCount 50
        DOSPageInterval 1
        DOSSiteInterval 1
        DOSBlockingPeriod 10
    </IfModule>
</VirtualHost>

# Health check endpoint
<VirtualHost *:8080>
    ServerName localhost
    DocumentRoot /var/www/erp

    <Location "/health">
        Require all granted
        SetHandler default-handler
        ErrorDocument 200 "healthy"
    </Location>
</VirtualHost>
